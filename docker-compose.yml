services:
  rpe-service:
    build: ./services/rpe-service
    image: docker.io/oleksiikomarychev/workoutapp-rpe-service:latest
    container_name: rpe-service
    env_file:
      - .env
    environment:
      - RPE_TABLE_PATH=/app/rpe_table.json
    ports:
      - "8001:8001"
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8001/rpe/health"]
      interval: 5s
      timeout: 5s
      retries: 15
      start_period: 30s
    networks:
      - workout-net

  plans-service:
    build: ./services/plans-service
    image: docker.io/oleksiikomarychev/workoutapp-plans-service:latest
    container_name: plans-service
    env_file:
      - .env
    environment:
      - DATABASE_URL=${PLANS_DATABASE_URL}
      - ENABLE_EXERCISES_ROUTER=true
      - WORKOUTS_SERVICE_URL=http://workouts-service:8004
      - EXERCISES_SERVICE_URL=http://exercises-service:8002
      - CORS_ORIGINS=*
    volumes:
      - plans_data:/app/data
      - ./services/plans-service/alembic:/app/alembic
    ports:
      - "8005:8005"
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8005/health"]
      interval: 5s
      timeout: 5s
      retries: 15
      start_period: 30s
    networks:
      - workout-net

  exercises-service:
    build:
      context: ./services/exercises-service
    image: docker.io/oleksiikomarychev/workoutapp-exercises-service:latest
    container_name: exercises-service
    env_file:
      - .env
    environment:
      - DATABASE_URL=${EXERCISES_DATABASE_URL}
      - PYTHONPATH=/app
    volumes:
      - exercises_data:/app/data
      - ./services/exercises-service/alembic:/app/alembic
    ports:
      - "8002:8002"
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8002/health"]
      interval: 5s
      timeout: 5s
      retries: 15
      start_period: 30s
    networks:
      - workout-net

  gateway:
    build: ./gateway
    image: docker.io/oleksiikomarychev/workoutapp-gateway:latest
    container_name: api-gateway
    env_file:
      - .env
    environment:
      RPE_SERVICE_URL: "http://rpe-service:8001"
      EXERCISES_SERVICE_URL: "http://exercises-service:8002"
      USER_MAX_SERVICE_URL: "http://user-max-service:8003"
      WORKOUTS_SERVICE_URL: "http://workouts-service:8004"
      PLANS_SERVICE_URL: "http://plans-service:8005"
      AGENT_SERVICE_URL: "http://agent-service:8006"
      ACCOUNTS_SERVICE_URL: "http://accounts-service:8007"
      MONO_WORKOUTS: "true"
      FIREBASE_CREDENTIALS_BASE64: "${FIREBASE_CREDENTIALS_BASE64}"
      FIREBASE_PROJECT_ID: "${FIREBASE_PROJECT_ID}"
      FIREBASE_AUTH_EMULATOR_HOST: "host.docker.internal:9099"
    ports:
      - "8000:8000"
    depends_on:
      exercises-service:
        condition: service_healthy
      user-max-service:
        condition: service_healthy
      rpe-service:
        condition: service_healthy
      plans-service:
        condition: service_healthy
      workouts-service:
        condition: service_healthy
      accounts-service:
        condition: service_healthy
    restart: unless-stopped
    networks:
      - workout-net
      - default

  user-max-service:
    build: ./services/user-max-service
    image: docker.io/oleksiikomarychev/workoutapp-user-max-service:latest
    container_name: user-max-service
    env_file:
      - .env
    environment:
      - DATABASE_URL=${USER_MAX_DATABASE_URL}
      - EXERCISES_SERVICE_URL=http://exercises-service:8002
    volumes:
      - user_max_data:/app/data
      - ./services/user-max-service/alembic:/app/alembic
    ports:
      - "8003:8003"
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8003/health"]
      interval: 5s
      timeout: 5s
      retries: 20
      start_period: 90s
    networks:
      - workout-net

  workouts-service:
    build: ./services/workouts-service
    image: docker.io/oleksiikomarychev/workoutapp-workouts-service:latest
    container_name: workouts-service
    env_file:
      - .env
    environment:
      - WORKOUTS_DATABASE_URL=${WORKOUTS_DATABASE_URL}
      - PLANS_SERVICE_URL=http://plans-service:8005
      - EXERCISES_SERVICE_URL=http://exercises-service:8002
      - RPE_SERVICE_URL=http://rpe-service:8001
      - USER_MAX_SERVICE_URL=http://user-max-service:8003
    volumes:
      - workouts_data:/app/data
      - ./services/workouts-service/alembic/versions:/app/alembic/versions
    ports:
      - "8004:8004"
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8004/health"]
      interval: 5s
      timeout: 5s
      retries: 15
      start_period: 30s
    networks:
      - workout-net

  agent-service:
    build:
      context: ./services/agent-service
    image: docker.io/oleksiikomarychev/workoutapp-agent-service:latest
    environment:
      - LLM_SPLIT_GENERATION=1
      - AGENT_DATABASE_URL=${AGENT_DATABASE_URL}
      - RPE_TABLE_URL=http://rpe-service:8001/rpe/table
      - EXERCISES_SERVICE_URL=http://exercises-service:8002
      - PLANS_SERVICE_URL=http://plans-service:8005
      - GEMINI_API_KEY=${GEMINI_API_KEY}
      - HF_TOKEN=${HF_TOKEN}
    ports:
      - "8006:8006"
    depends_on:
      - user-max-service
      - exercises-service
      - plans-service
    restart: unless-stopped
    networks:
      - workout-net

  accounts-service:
    build: ./services/accounts-service
    image: docker.io/oleksiikomarychev/workoutapp-accounts-service:latest
    container_name: accounts-service
    env_file:
      - .env
    environment:
      - ACCOUNTS_DATABASE_URL=${ACCOUNTS_DATABASE_URL}
    ports:
      - "8007:8007"
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8007/health"]
      interval: 5s
      timeout: 5s
      retries: 15
      start_period: 30s
    networks:
      - workout-net


volumes:
  exercises_data:
  user_max_data:
  workouts_data:
  plans_data:

networks:
  workout-net:
    driver: bridge
