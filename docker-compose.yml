services:
  rpe-service:
    build: ./services/rpe-service
    container_name: rpe-service
    env_file:
      - .env
    environment:
      - RPE_TABLE_PATH=/app/rpe_table.json
    ports:
      - "8001:8001"
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8001/health"]
      interval: 5s
      timeout: 5s
      retries: 15
      start_period: 30s
    networks:
      - workout-net

  plans-service:
    build: ./services/plans-service
    container_name: plans-service
    env_file:
      - .env
    environment:
      - DATABASE_URL=${PLANS_DATABASE_URL}
      - ENABLE_EXERCISES_ROUTER=true
      - WORKOUTS_SERVICE_URL=http://workouts-service:8004
    volumes:
      - plans_data:/app/data
      - ./services/plans-service/alembic:/app/alembic
    ports:
      - "8005:8005"
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8005/health"]
      interval: 5s
      timeout: 5s
      retries: 15
      start_period: 30s
    networks:
      - workout-net

  exercises-service:
    build:
      context: ./services/exercises-service
    container_name: exercises-service
    env_file:
      - .env
    environment:
      - DATABASE_URL=${EXERCISES_DATABASE_URL}
      - PYTHONPATH=/app
    volumes:
      - exercises_data:/app/data
      - ./services/exercises-service/alembic:/app/alembic
    ports:
      - "8002:8002"
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8002/health"]
      interval: 5s
      timeout: 5s
      retries: 15
      start_period: 30s
    networks:
      - workout-net

  gateway:
    build: ./gateway
    container_name: api-gateway
    env_file:
      - .env
    environment:
      RPE_SERVICE_URL: "http://rpe-service:8001"
      EXERCISES_SERVICE_URL: "http://exercises-service:8002"
      USER_MAX_SERVICE_URL: "http://user-max-service:8003"
      WORKOUTS_SERVICE_URL: "http://workouts-service:8004"
      PLANS_SERVICE_URL: "http://plans-service:8005"
      MONO_WORKOUTS: "true"
      FIREBASE_CREDENTIALS_BASE64: "${FIREBASE_CREDENTIALS_BASE64}"
    ports:
      - "8000:8000"
    depends_on:
      exercises-service:
        condition: service_healthy
      user-max-service:
        condition: service_healthy
      rpe-service:
        condition: service_healthy
      plans-service:
        condition: service_healthy
      workouts-service:
        condition: service_healthy
    restart: unless-stopped
    networks:
      - workout-net
      - default

  user-max-service:
    build: ./services/user-max-service
    container_name: user-max-service
    env_file:
      - .env
    environment:
      - DATABASE_URL=${USER_MAX_DATABASE_URL}
    volumes:
      - user_max_data:/app/data
      - ./services/user-max-service/alembic:/app/alembic
    ports:
      - "8003:8003"
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8003/health"]
      interval: 5s
      timeout: 5s
      retries: 20
      start_period: 90s
    networks:
      - workout-net

  workouts-service:
    build: ./services/workouts-service
    container_name: workouts-service
    env_file:
      - .env
    environment:
      - WORKOUTS_DATABASE_URL=${WORKOUTS_DATABASE_URL}
    volumes:
      - workouts_data:/app/data
      - ./services/workouts-service/alembic/versions:/app/alembic/versions
    ports:
      - "8004:8004"
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8004/health"]
      interval: 5s
      timeout: 5s
      retries: 15
      start_period: 30s
    networks:
      - workout-net

volumes:
  exercises_data:
  user_max_data:
  workouts_data:
  plans_data:

networks:
  workout-net:
    driver: bridge
